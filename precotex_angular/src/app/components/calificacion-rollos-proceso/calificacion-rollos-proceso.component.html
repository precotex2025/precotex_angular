<div class="registro-container">
  <div class="title">Inspeccion Calidad en Proceso</div>

    <div class="filtros">

      <label for="auditorSelect">Auditor:
        <select id="auditorSelect" [(ngModel)]="PartidaCab.auditor" name="auditor">
          <option *ngFor="let c of auditorList; let i = index"
                  [value]="c.acronimo"
                  [selected]="i === 0"> {{ c.acronimo }}
          </option>
        </select>
      </label>

      <label for="supervisorSelect">Supervisor:
        <select id="supervisorSelect" [(ngModel)]="PartidaCab.supervisor" name="supervisor">
          <option *ngFor="let c of supervisorList; let i = index"
                  [value]="c.acronimo"
                  [selected]="i === 0">{{ c.acronimo }}</option>
        </select>
      </label>

      <label for="maquinaSelect">Maquina:
        <select id="maquinaSelect" [(ngModel)]="PartidaCab.maquina" name="maquina">
          <option *ngFor="let c of maquinaList; let i = index" [value]="c.acronimo"
                  [selected]="i === 0">{{ c.acronimo }}</option>
        </select>
      </label>

      <label for="turnoSelect">Turno:
        <select id="turnoSelect" [(ngModel)]="PartidaCab.turno" name="turno">
          <option *ngFor="let c of turnoList; let i = index" [value]="c.acronimo"
                  [selected]="i === 0">{{ c.acronimo }}</option>
        </select>
      </label>

      <label for="unidadNegocioSelect">Unidad de Negocio:
        <select id="unidadNegocioSelect" [(ngModel)]="PartidaCab.unidadNegocio" name="unidadNegocio">
          <option *ngFor="let c of unidadNegocioList; let i = index" [value]="c.acronimo"
                  [selected]="i === 0">{{ c.acronimo }}</option>
        </select>
      </label>

      <label for="estadoPartidaSelect">Estado Partida:
        <select id="estadoPartidaSelect" [(ngModel)]="PartidaCab.estadoPartida" name="estadoPartida">
          <option *ngFor="let c of estadoPartidaList; let i = index" [value]="c.acronimo"
                  [selected]="i === 0">{{ c.acronimo }}</option>
        </select>
      </label>

      <label for="calificacionSelect">Tono:
        <select id="calificacionSelect" id="estadoPartidaSelect" [(ngModel)]="PartidaCab.calificacion" name="calificacion">
          <option *ngFor="let c of calificacionList; let i = index" [value]="c.acronimo"
                  [selected]="i === 0">{{ c.acronimo }}</option>
        </select>
      </label>

      <label for="calificacionSelect">Estado Proceso:
        <select id="calificacionSelect" id="estadoPartidaSelect" [(ngModel)]="PartidaCab.estadoProceso" name="calificacion">
          <option *ngFor="let c of estadoProcesoList; let i = index" [value]="c.acronimo"
                  [selected]="i === 0">{{ c.acronimo }}</option>
        </select>
      </label>

      <label for="estadoPartidaSelect">Proceso Auditado:
        <select id="estadoPartidaSelect" [(ngModel)]="PartidaCab.procesoAuditado" name="procesoAuditado">
          <option *ngFor="let c of procesoAuditadoaList; let i = index"

                  [selected]="i === 0">{{ c.acronimo }}</option>
        </select>
      </label>

      <label for="calificacionSelect">Observaciones:
        <input type="text" [(ngModel)]="PartidaCab.observaciones" name="datosObservaciones"/>
      </label>

    </div>

  <!-- Zona principal -->
  <div class="main-grid">
    <!-- Datos de partida -->
    <div class="panel datos-partida">
      <h3>Datos de partida</h3>

      <label>Partida <input type="text" [(ngModel)]="PartidaCab.datosPartida" name="datosPartida"/></label>

      <div style="display: flex; align-items: center; gap: 1.5rem;">
        <!-- Bot√≥n Buscar (se oculta si checkbox est√° marcado) -->
        <button class="buscar-btn" *ngIf="!checkboxSeleccionado" (click)="buscar()">Buscar</button>

        <!-- Checkbox en una sola l√≠nea -->
        <label style="display: inline-flex; align-items: center; white-space: nowrap; cursor: pointer;">
          <input
            type="checkbox"
            (change)="toggleSeleccionTodos($event)"
            aria-label="Seleccionar todos"
            style="margin-right: 0.5rem;"
          />
          <span>Defecto por partida</span>
        </label>
      </div>




      <br>
      <label>Tela <input type="text" [(ngModel)]="PartidaCab.datosTela" name="datosTela" disabled/></label>
      <label>Cliente <input type="text" [(ngModel)]="PartidaCab.datosCliente" name="datosCliente" disabled/></label>
      <label>N¬∞ Rollo <input type="text" [value]="totalItems" readonly disabled/></label>

      <!-- Sin resultados -->
      <div *ngIf="!isLoading && sinResultados" class="mensaje-alerta">
        ‚ö†Ô∏è No se encontraron resultados para "{{ datosPartida }}"
      </div>

      <!-- Resultados -->
      <ul *ngIf="resultadoBusqueda.length > 0">
        <li *ngFor="let item of resultadoBusqueda">
          {{ item | json }}
        </li>
      </ul>

      <div class="tabla-scroll" *ngIf="!checkboxSeleccionado">
        <table>
          <thead>
            <tr>
              <th>
                <span class="visually-hidden">Selec.</span>

              </th>
              <th>Rollo</th>
              <th>Mtrs</th>
              <ng-container *ngIf="primerosDos === 'RE'; else mostrarSoloMtrsAudi">
                <th>Medi Audi.</th>
              </ng-container>
              <ng-template #mostrarSoloMtrsAudi>
                <th>Mtrs Audi.</th>
              </ng-template>
              <th>Ancho</th>
              <th>Densidad</th>

              <th>Acci√≥n</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor=" let item of pagedPartidaItemList; let i = index; trackBy: trackByFn "  [class.seleccionado]="item.sel">
              <td>
                <input type="checkbox" [checked]="item.sel" (change)="toggleSeleccion(item, i)" />
              </td>
              <td>{{ item.rollo }}</td>
              <td>{{ item.mtrs2_T === 0 ? '0' : item.mtrs2_T }}</td>

              <td>
                <ng-container *ngIf="item.isEditing; else showMtrsAuditados">
                  <input type="number"
                         [(ngModel)]="item.mtrsAuditados"
                         min="0"
                         style="width: 80px;" />
                </ng-container>
                <ng-template #showMtrsAuditados>
                  {{ item.mtrsAuditados === 0 ? '0' : item.mtrsAuditados }}
                </ng-template>
              </td>

              <td>
                <ng-container *ngIf="item.isEditing; else showAncho">
                  <input type="number"
                         [(ngModel)]="item.ancho"
                         min="0"
                         style="width: 80px;" />
                </ng-container>
                <ng-template #showAncho>
                  {{ item.ancho === 0 ? '0' : item.ancho }}
                </ng-template>
              </td>

              <td>
                <ng-container *ngIf="item.isEditing; else showDensidad">
                  <input type="number"
                         [(ngModel)]="item.densidad"
                         min="0"
                         style="width: 80px;" />
                </ng-container>
                <ng-template #showDensidad>
                  {{ item.densidad === 0 ? '0' : item.densidad }}
                </ng-template>
              </td>

              <td>
                <ng-container *ngIf="item.isEditing; else editButton">
                  <button (click)="guardarEdicion(item)">üíæ</button>
                </ng-container>
                <ng-template #editButton>
                  <button (click)="editarItem(item)" title="Editar">‚úèÔ∏è</button>
                </ng-template>
              </td>

            </tr>
          </tbody>
        </table>
        <div class="pagination">
          <button (click)="previousPage()" [disabled]="currentPage === 1">
            Atras
          </button>
          <span>Page {{ currentPage }} / {{ totalPages }}</span>
          <button (click)="nextPage()" [disabled]="currentPage === totalPages">Siguiente</button>
        </div>
      </div>

    </div>

    <!-- Lista de defectos -->
    <div class="panel lista-defectos">
      <h3>Lista defectos</h3>
      <div class="defecto-grid">
        <button
  class="defecto-btn"
  *ngFor="let defecto of defectoList | paginate: { itemsPerPage: 18, currentPage: p }"
  (click)="openOptionsPopup(defecto.coD_MOTIVO)"
  [ngClass]="{
    'categoria-aca': selectedCategoria === 'ACA',
    'categoria-hil': selectedCategoria === 'HIL',
    'categoria-tej': selectedCategoria === 'TEJ',
    'categoria-tin': selectedCategoria === 'TIN'
  }"
>
  {{ defecto.defecto }}
</button>
      </div>

      <pagination-controls (pageChange)="p = $event" class="custom-pagination"></pagination-controls>

      <div *ngIf="showOptionsPopup" class="options-popup">
        <h3>Seleccione Grado</h3>

      <input type="hidden" [(ngModel)]="selectedCodMotivo" name="codMotivo">
      <div *ngFor="let i of [1]">
          <div class="option-button-group">
              <button type="button" (click)="selectOption(i, '1')">Grado 1</button>
              <button type="button" (click)="selectOption(i, '2')">Grado 2</button>
              <button type="button" (click)="selectOption(i, '3')">Grado 3</button>
              <button type="button" (click)="selectOption(i, '4')">Grado 4</button>
              <button type="button" (click)="selectOption(i, '5')">Grado 5</button>
          </div>
      </div>
      <button class="btnCerrar" type="button" (click)="closeOptionsPopup()">Cerrar</button>
    </div>

      <div class="categorias">
        <button class="defecto-btnACA1" (click)="cargarDefectos('ACA')">acabados</button>
        <button class="defecto-btnHIL2"(click)="cargarDefectos('HIL')">hilanderia</button>
        <button class="defecto-btnTEJ3"(click)="cargarDefectos('TEJ')">tejeduria</button>
        <button class="defecto-btnTIN4"(click)="cargarDefectos('TIN')">tintoreria</button>
      </div>
    </div>
  </div>

  <!-- Defectos registrados -->
  <div class="panel defectos-registrados">
    <h3>Defectos registrados</h3>
    <table>
      <thead>
        <tr>
          <!--<th>Selec.</th>-->
          <th>Tela</th>
          <th>Rollo</th>
          <th>Motivo</th>
          <ng-container *ngIf="primerosDos === 'RE'; else mostrarSoloMtrsAudi">
            <th>Unid. Falladas</th>
          </ng-container>
          <ng-template #mostrarSoloMtrsAudi>
            <th>Metros</th>
          </ng-template>
          <th>Grado</th>
          <th>Accion</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let defecto of defectosRegistrados; let i = index; trackBy: trackByFn ">
          <!--<td>
            <input type="checkbox" [checked]="defecto.sel"
            />
          </td>-->
          <td>{{ defecto.codTela }}</td>
          <td>{{ defecto.codRollo }}</td>
          <td>{{ defecto.codMotivo }}</td>
          <td>{{ defecto.metros }}</td>
          <td>{{ defecto.grado }}</td>
          <td>
            <button class="delete-btn" (click)="eliminarDefecto(defecto, i)">üóëÔ∏è</button>
          </td>
        </tr>
      </tbody>
    </table>
    <div class="acciones-finales">
      <button class="defecto-btn" (click)="registrar()">Registrar</button>
      <div *ngIf="isSaving" class="loading-container">
        <img src="assets/spinner.gif" alt="Guardando..." width="40" />
        <p>Guardando informaci√≥n...</p>
      </div>

      <div *ngIf="mensajeExito" class="mensaje-resultado">
        {{ mensajeExito }}
      </div>
      <button class="defecto-btn" (click)="limpiar()">Limpiar</button>
    </div>
  </div>
</div>
